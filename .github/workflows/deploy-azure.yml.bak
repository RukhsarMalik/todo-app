name: Deploy to Azure AKS

# Trigger Configuration
on:
  push:
    branches:
      - main
    paths:
      - 'phase-5/backend/**'
      - 'phase-5/frontend/**'
      - 'phase-5/helm/**'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:  # Manual trigger

# Required GitHub Secrets
# AZURE_CREDENTIALS      - Service principal JSON from az ad sp create-for-rbac
# ACR_LOGIN_SERVER       - e.g., todoacr123.azurecr.io
# DATABASE_URL           - Neon PostgreSQL connection string
# JWT_SECRET_KEY         - JWT signing secret
# OPENAI_API_KEY         - OpenAI API key
# KAFKA_USERNAME         - Redpanda SASL username
# KAFKA_PASSWORD         - Redpanda SASL password
# KAFKA_BOOTSTRAP_SERVERS - Redpanda broker URL

env:
  RESOURCE_GROUP: todo-rg
  CLUSTER_NAME: todo-cluster
  NAMESPACE: todo

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Step 3: Get ACR name
      - name: Get ACR name
        id: acr
        run: |
          ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          echo "name=$ACR_NAME" >> $GITHUB_OUTPUT

      # Step 4: Build and push backend image
      - name: Build backend
        run: |
          az acr build \
            --registry ${{ steps.acr.outputs.name }} \
            --image backend:${{ github.sha }} \
            --image backend:latest \
            ./phase-5/backend

      # Step 5: Build and push frontend image
      - name: Build frontend
        run: |
          az acr build \
            --registry ${{ steps.acr.outputs.name }} \
            --image frontend:${{ github.sha }} \
            --image frontend:latest \
            ./phase-5/frontend

      # Step 6: Get AKS credentials
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.CLUSTER_NAME }} \
            --overwrite-existing

      # Step 7: Create/Update Kubernetes secrets
      - name: Update Kubernetes secrets
        run: |
          kubectl create secret generic app-secrets -n ${{ env.NAMESPACE }} \
            --from-literal=database-url="${{ secrets.DATABASE_URL }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET_KEY }}" \
            --from-literal=openai-api-key="${{ secrets.OPENAI_API_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic kafka-secrets -n ${{ env.NAMESPACE }} \
            --from-literal=username="${{ secrets.KAFKA_USERNAME }}" \
            --from-literal=password="${{ secrets.KAFKA_PASSWORD }}" \
            --from-literal=bootstrap-servers="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      # Step 8: Deploy with Helm
      - name: Helm deploy
        run: |
          helm upgrade --install todo ./phase-5/helm/todo-chart \
            --namespace ${{ env.NAMESPACE }} \
            --values ./phase-5/helm/todo-chart/values-azure.yaml \
            --set backend.image.repository=${{ secrets.ACR_LOGIN_SERVER }}/backend \
            --set backend.image.tag=${{ github.sha }} \
            --set frontend.image.repository=${{ secrets.ACR_LOGIN_SERVER }}/frontend \
            --set frontend.image.tag=${{ github.sha }} \
            --wait \
            --timeout 5m

      # Step 9: Verify deployment
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=120s
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=120s
          echo "Deployment successful!"

          EXTERNAL_IP=$(kubectl get svc frontend -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Frontend URL: http://$EXTERNAL_IP"

# Expected Workflow Timing
# - Checkout: ~5s
# - Azure Login: ~10s
# - Build backend: ~2-3 min
# - Build frontend: ~2-3 min
# - Get AKS credentials: ~10s
# - Update secrets: ~5s
# - Helm deploy: ~1-2 min
# - Verify: ~30s
# Total: ~6-8 minutes (under SC-006 target of 10 min)