# Data Model: Task Entity

**Module**: Phase II - Module 1 of 5
**Date**: 2026-01-16
**Status**: Complete

---

## Entity Overview

The Task entity represents a todo item belonging to a specific user. It is the core data structure for the todo application.

---

## Task Entity Definition

### Attributes

| Field | Type | Constraints | Default | Description |
|-------|------|-------------|---------|-------------|
| `id` | int | Primary Key, Auto-increment | None (auto) | Unique identifier |
| `user_id` | str | Required, FK→users.id, Indexed, Max 255 | - | Owner reference |
| `title` | str | Required, 1-200 chars | - | Task title |
| `description` | str | Optional, Max 1000 chars | None | Task details |
| `completed` | bool | Required | False | Completion status |
| `created_at` | datetime | Required, Immutable | UTC now | Creation timestamp |
| `updated_at` | datetime | Required | UTC now | Last modification |

### Entity Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                          Task                                │
├─────────────────────────────────────────────────────────────┤
│  PK  id           : int          [auto-increment]           │
│  FK  user_id      : str(255)     [→users.id, indexed]       │
│      title        : str(200)     [required]                 │
│      description  : str(1000)    [optional]                 │
│      completed    : bool         [default: false]           │
│      created_at   : datetime     [auto-set, immutable]      │
│      updated_at   : datetime     [auto-updated]             │
├─────────────────────────────────────────────────────────────┤
│  Indexes:                                                   │
│    - idx_tasks_user_id (user_id)                           │
│    - idx_tasks_completed (completed)                        │
├─────────────────────────────────────────────────────────────┤
│  Constraints:                                               │
│    - fk_tasks_user_id → users(id) ON DELETE CASCADE        │
│    - check_title_length: 1 <= len(title) <= 200            │
│    - check_desc_length: len(description) <= 1000           │
└─────────────────────────────────────────────────────────────┘
```

---

## Relationships

### Task → User (Many-to-One)

```
┌──────────────┐         ┌──────────────┐
│    users     │         │    tasks     │
├──────────────┤         ├──────────────┤
│ PK id        │◄────────│ FK user_id   │
│    email     │    1:N  │    title     │
│    ...       │         │    ...       │
└──────────────┘         └──────────────┘

- One user has many tasks
- One task belongs to exactly one user
- Deleting user cascades to delete all their tasks
```

### Relationship Rules

| Rule | Behavior |
|------|----------|
| **Ownership** | Task.user_id must reference valid User |
| **Cascade Delete** | When user deleted, all their tasks deleted |
| **No Orphans** | Tasks cannot exist without owner |
| **Isolation** | User can only access their own tasks |

---

## Field Specifications

### id (Primary Key)

```python
id: Optional[int] = Field(default=None, primary_key=True)
```

- Auto-generated by PostgreSQL SERIAL
- Immutable after creation
- Used for API endpoints: `/api/tasks/{id}`

### user_id (Foreign Key)

```python
user_id: str = Field(
    index=True,
    nullable=False,
    max_length=255,
    foreign_key="user.id"
)
```

- References Better Auth user ID
- Indexed for query performance
- All task queries filtered by user_id
- Max 255 chars to accommodate various ID formats

### title (Required)

```python
title: str = Field(
    min_length=1,
    max_length=200,
    nullable=False
)
```

- Required field, cannot be empty
- Max 200 characters for concise titles
- Validated at model level

### description (Optional)

```python
description: Optional[str] = Field(
    default=None,
    max_length=1000
)
```

- Optional detailed information
- Max 1000 characters for detailed descriptions
- None if not provided

### completed (Status)

```python
completed: bool = Field(
    default=False,
    nullable=False
)
```

- Boolean completion status
- Defaults to False (incomplete)
- Indexed for status-based queries

### created_at (Timestamp)

```python
created_at: datetime = Field(
    default_factory=datetime.utcnow,
    nullable=False
)
```

- Set automatically on creation
- Immutable (never updated)
- UTC timezone

### updated_at (Timestamp)

```python
updated_at: datetime = Field(
    default_factory=datetime.utcnow,
    nullable=False
)
```

- Set on creation
- Updated on any modification (Module 2 implements update logic)
- UTC timezone

---

## Validation Rules

### Model-Level Validation

| Field | Rule | Error |
|-------|------|-------|
| title | 1-200 chars | "Title must be 1-200 characters" |
| description | max 1000 chars | "Description exceeds 1000 characters" |
| user_id | required | "User ID is required" |

### Database-Level Constraints

```sql
-- Title length check
CONSTRAINT check_title_length
    CHECK (char_length(title) >= 1 AND char_length(title) <= 200)

-- Description length check
CONSTRAINT check_desc_length
    CHECK (description IS NULL OR char_length(description) <= 1000)

-- Foreign key with cascade
CONSTRAINT fk_tasks_user_id
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
```

---

## State Transitions

```
┌─────────────┐     toggle()     ┌─────────────┐
│  INCOMPLETE │◄────────────────►│  COMPLETE   │
│ completed=F │                  │ completed=T │
└─────────────┘                  └─────────────┘
      │                                │
      │ create()                       │
      │                                │
      ▼                                ▼
┌─────────────────────────────────────────────┐
│              delete()                        │
│         (task removed)                       │
└─────────────────────────────────────────────┘
```

### Valid Operations

| Operation | From State | To State | Trigger |
|-----------|------------|----------|---------|
| Create | - | INCOMPLETE | POST /api/tasks |
| Toggle | INCOMPLETE | COMPLETE | PATCH /api/tasks/{id}/toggle |
| Toggle | COMPLETE | INCOMPLETE | PATCH /api/tasks/{id}/toggle |
| Update | Any | Same | PUT /api/tasks/{id} |
| Delete | Any | Removed | DELETE /api/tasks/{id} |

---

## Query Patterns

### Common Queries

```sql
-- Get all tasks for a user
SELECT * FROM tasks WHERE user_id = $1 ORDER BY created_at DESC;

-- Get incomplete tasks for a user
SELECT * FROM tasks WHERE user_id = $1 AND completed = false;

-- Get task by ID (with ownership check)
SELECT * FROM tasks WHERE id = $1 AND user_id = $2;

-- Count tasks by status for a user
SELECT completed, COUNT(*) FROM tasks WHERE user_id = $1 GROUP BY completed;
```

### Index Usage

| Query Pattern | Index Used |
|--------------|------------|
| WHERE user_id = ? | idx_tasks_user_id |
| WHERE user_id = ? AND completed = ? | idx_tasks_user_id, idx_tasks_completed |
| ORDER BY created_at | (sequential scan, acceptable for small datasets) |

---

## SQLModel Implementation

```python
from sqlmodel import SQLModel, Field
from datetime import datetime
from typing import Optional


class Task(SQLModel, table=True):
    """
    Task model representing a todo item in the database.

    Attributes:
        id: Unique identifier (auto-generated)
        user_id: Reference to the user who owns this task
        title: Task title (1-200 characters, required)
        description: Optional task details (max 1000 characters)
        completed: Task completion status (default: False)
        created_at: Timestamp when task was created
        updated_at: Timestamp when task was last modified
    """
    __tablename__ = "tasks"

    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: str = Field(
        index=True,
        nullable=False,
        max_length=255,
        foreign_key="user.id"
    )
    title: str = Field(
        min_length=1,
        max_length=200,
        nullable=False
    )
    description: Optional[str] = Field(
        default=None,
        max_length=1000
    )
    completed: bool = Field(
        default=False,
        nullable=False
    )
    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        nullable=False
    )
    updated_at: datetime = Field(
        default_factory=datetime.utcnow,
        nullable=False
    )
```

---

## Integration Notes

### Module 2 (Backend API) Usage

```python
from models import Task
from db import get_session

# Create task
async def create_task(session: AsyncSession, user_id: str, title: str):
    task = Task(user_id=user_id, title=title)
    session.add(task)
    await session.commit()
    await session.refresh(task)
    return task
```

### Module 3 (Authentication) Dependency

- Task.user_id references user from Better Auth
- FK constraint enforced after users table exists
- User deletion cascades to task deletion
